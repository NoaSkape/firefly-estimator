# DocuSeal Template Creation & Integration Rules

## Overview
This rule documents the complete process for creating and integrating DocuSeal templates in the Firefly Estimator project, based on successful implementation and debugging. **CRITICAL**: This rule contains the FINAL WORKING SOLUTION that resolves the persistent "Template does not contain fields" error.

## Environment Setup

### Required Environment Variables (.env)
```env
# DocuSeal Configuration
DOCUSEAL_API_KEY=your_full_43_character_api_key_here
DOCUSEAL_BASE_URL=https://api.docuseal.co
DOCUSEAL_FIREFLY_EMAIL=office@fireflytinyhomes.com

# Template IDs (generated after template creation)
# ‚úÖ WORKING TEMPLATES (as of 2025-09-08):
DOCUSEAL_TEMPLATE_ID_AGREEMENT=1710241
DOCUSEAL_TEMPLATE_ID_DELIVERY=1710288
DOCUSEAL_TEMPLATE_ID_FINAL=template_id_here
```

### Critical Environment Loading Rules
1. **Dev Server**: Must load .env from project root using `dotenv.config({ path: path.join(__dirname, '..', '.env') })`
2. **API Routes**: Environment variables must be available before importing DocuSeal modules
3. **Variable Consistency**: Use `BASE` internally, load from `DOCUSEAL_BASE_URL`

## DocuSeal API Integration Architecture

### 1. Client Configuration (lib/docuseal/client.js)
```javascript
// ‚úÖ CORRECT: Load environment variables at module level
const BASE = process.env.DOCUSEAL_BASE_URL || "https://api.docuseal.co"
const API_KEY = process.env.DOCUSEAL_API_KEY

// ‚úÖ CORRECT: Headers function
function hdr(json = true) {
  return {
    "X-Auth-Token": API_KEY,  // Use X-Auth-Token, NOT Bearer
    ...(json ? { "Content-Type": "application/json", "Accept": "application/json" } : {}),
  }
}

// ‚úÖ CORRECT: HTML Template Creation (NOT DOCX for HTML content)
export async function dsCreateTemplateFromHtml(body) {
  const res = await fetch(`${BASE}/templates/html`, {  // Use /templates/html for HTML
    method: "POST",
    headers: hdr(true),
    body: JSON.stringify(body),
  })
  // ... error handling and response parsing
}
```

### 2. HTML Template Structure (lib/contracts/html/*.js)

#### üö® CRITICAL: Field Tag Syntax Rules
**ROOT CAUSE IDENTIFIED**: DocuSeal's HTML API (`/templates/html`) requires **HTML element syntax**, not curly brace syntax!

```html
<!-- ‚úÖ CORRECT: HTML element syntax for /templates/html endpoint -->
<text-field name="buyer_full_name" role="buyer" required="true" style="display: inline-block; border: 1px solid #ccc; padding: 4px; width: 200px; height: 20px;"></text-field>
<signature-field name="buyer_signature" role="buyer" required="true" style="display: inline-block; border: 1px solid #ccc; padding: 4px; width: 200px; height: 50px;"></signature-field>
<initials-field name="buyer_initials_1" role="buyer" required="true" style="display: inline-block; border: 1px solid #ccc; padding: 4px; width: 60px; height: 30px;"></initials-field>

<!-- ‚ùå WRONG: Curly brace syntax (only works for PDF templates) -->
{{field_name;type=text;role=buyer;required=true}}
{{buyer_signature;type=signature;role=buyer;required=true}}

<!-- ‚ùå WRONG: Simple placeholder syntax -->
{{field_name}}
[[FIELD_NAME]]
```

#### Field Conversion Process
Use `lib/contracts/html/field-converter.js` to convert curly brace syntax to HTML elements:

```javascript
// 1. Generate HTML with curly brace field tags
const htmlWithFieldTags = `<!doctype html>
<html>
<body>
  <p>Buyer Name: {{buyer_full_name;type=text;role=buyer;required=true}}</p>
  <p>Signature: {{buyer_signature;type=signature;role=buyer;required=true}}</p>
</body>
</html>`

// 2. Convert to HTML elements for DocuSeal HTML API
import { convertFieldTagsToHtmlElements } from './field-converter.js'
const finalHtml = convertFieldTagsToHtmlElements(htmlWithFieldTags)
```

#### Field Converter Implementation
The `field-converter.js` utility is the **CRITICAL BREAKTHROUGH** that resolves the "Template does not contain fields" error:

```javascript
// lib/contracts/html/field-converter.js
export function convertFieldTagsToHtmlElements(htmlContent) {
  return htmlContent.replace(/\{\{([^;]+);type=([^;]+);role=([^;]+);required=(true|false)([^}]+)?\}\}/g, 
    (match, name, type, role, required, rest) => {
      const style = "display: inline-block; border: 1px solid #ccc; padding: 4px;"
      let width = "200px";
      let height = "20px";
      
      // Adjust size based on type
      if (type === 'signature') {
        height = "50px";
      } else if (type === 'initials') {
        width = "60px";
        height = "30px";
      }

      const attributes = [
        `name="${name}"`,
        `role="${role}"`,
        `required="${required}"`,
        `style="${style}width: ${width}; height: ${height};"`
      ].join(' ');

      switch (type) {
        case 'text':
          return `<text-field ${attributes}></text-field>`;
        case 'signature':
          return `<signature-field ${attributes}></signature-field>`;
        case 'initials':
          return `<initials-field ${attributes}></initials-field>`;
        case 'date':
          return `<date-field ${attributes}></date-field>`;
        default:
          return `<text-field ${attributes}></text-field>`;
      }
    });
}
```

**This converter transforms:**
- `{{buyer_full_name;type=text;role=buyer;required=true}}` 
- **‚Üí** `<text-field name="buyer_full_name" role="buyer" required="true" style="..."></text-field>`

#### Role Naming Convention
- **buyer**: Primary buyer/customer
- **cobuyer**: Secondary buyer (optional)
- **firefly_signer**: Firefly Tiny Homes representative

#### Field Type Mapping
- `type=text`: Text input fields (names, addresses, prices)
- `type=signature`: Signature fields
- `type=initials`: Initial fields (use multiple with different names: buyer_initials_1, buyer_initials_2)
- `type=date`: Date fields

### 3. Template Builder Pattern (lib/docuseal/builders/*.js)
```javascript
export async function buildAgreementTemplate() {
  // 1. Generate HTML with curly brace field tags
  const html = buildAgreementHtmlForDocuSeal()

  // 2. Create template body for HTML endpoint
  const templateBody = {
    name: "Firefly ‚Äì Master Retail Purchase Agreement (Cash Sale) v4 FIXED",
    html: html,                    // HTML content with field elements
    size: "Letter",               // Page size
    external_id: "firefly_agreement_v4_fixed",     // Unique identifier
    folder_name: "Firefly Templates",   // Organization
    shared_link: true,            // Allow sharing
    // üö® CRITICAL: Explicitly define roles for multi-party signing
    roles: ['buyer', 'cobuyer', 'firefly_signer']
  }

  // 3. Call HTML endpoint (NOT DOCX)
  const templateId = await dsCreateTemplateFromHtml(templateBody)
  return templateId
}
```

## Development Server Integration

### Dev Server Endpoint Pattern (backend/dev-server.js)
```javascript
// Template creation endpoint for development
app.post('/api/admin/docuseal/init-templates/agreement', async (req, res) => {
  try {
    const { buildAgreementTemplate } = await import('../lib/docuseal/builders/agreement.js')
    const templateId = await buildAgreementTemplate()
    
    res.json({
      success: true,
      templateId,
      message: 'Template created successfully',
      envVariable: 'DOCUSEAL_TEMPLATE_ID_AGREEMENT',
      instructions: `Add this to your .env file: DOCUSEAL_TEMPLATE_ID_AGREEMENT=${templateId}`
    })
  } catch (error) {
    res.status(500).json({
      success: false,
      error: 'Failed to create template',
      details: error.message
    })
  }
})
```

## Data Mapping Rules

### Order-to-Template Field Mapping
```javascript
// ‚úÖ CORRECT: Field names must match template exactly
function buildPackFields(pack, order) {
  return {
    // Buyer information - match template field names exactly
    buyer_full_name: order.buyer.firstName + ' ' + order.buyer.lastName,
    buyer_email: order.buyer.email,
    buyer_phone: order.buyer.phone,
    buyer_address: formatAddress(order.deliveryAddress),
    
    // Model information - match template field names exactly  
    model_brand: order.model.brand,
    model_code: order.model.model,
    model_year: order.model.year,
    dimensions: order.model.dimensions,
    
    // Pricing - match template field names exactly
    price_base: formatCurrency(order.pricing.base),
    price_options: formatCurrency(order.pricing.options),
    price_freight_est: formatCurrency(order.pricing.delivery || 0),
    price_setup: formatCurrency(order.pricing.setup || 0),
    price_other: formatCurrency(order.pricing.titleFee || 0),
    price_total: formatCurrency(order.pricing.total),
    
    // Co-buyer fields (optional)
    cobuyer_full_name: order.buyer.coFirstName ? order.buyer.coFirstName + ' ' + order.buyer.coLastName : '',
    cobuyer_email: order.buyer.coEmail || ''
  }
}
```

### Session Creation Rules
```javascript
// ‚úÖ CORRECT: Role names must match template submitters + proper order
const submitters = [
  {
    name: order.buyer.firstName + ' ' + order.buyer.lastName,
    email: order.buyer.email,
    role: 'buyer',  // Must match template role exactly
    order: 0        // üö® CRITICAL: Parallel signing (buyer + co-buyer)
  },
  // Co-buyer (optional)
  ...(order.coBuyer.firstName ? [{
    name: order.coBuyer.firstName + ' ' + order.coBuyer.lastName,
    email: order.coBuyer.email || order.buyer.email,
    role: 'cobuyer',  // Must match template role exactly
    order: 0          // üö® CRITICAL: Parallel signing (buyer + co-buyer)
  }] : []),
  {
    name: 'Firefly Tiny Homes',
    email: 'office@fireflytinyhomes.com',
    role: 'firefly_signer',  // Must match template role exactly
    order: 1                 // üö® CRITICAL: Sequential signing (after buyer/co-buyer)
  }
]
```

## Common Pitfalls & Solutions

### ‚ùå WRONG Approaches
1. **Using /templates/docx for HTML content**: This endpoint expects base64-encoded DOCX files
2. **Curly brace syntax for HTML API**: `{{field_name;type=text}}` only works for PDF templates
3. **Missing field conversion**: Not converting curly braces to HTML elements
4. **Missing roles in template**: Not defining `roles: ['buyer', 'cobuyer', 'firefly_signer']`
5. **Missing order in submitters**: Not setting `order: 0` for parallel, `order: 1` for sequential
6. **Mismatched field names**: Template expects `buyer_full_name`, session sends `buyer_name`
7. **Wrong role names**: Template has `buyer`, session sends `Buyer`
8. **Bearer authentication**: Use `X-Auth-Token` header instead
9. **Environment loading**: Loading .env from wrong directory in dev server

### ‚úÖ CORRECT Solutions
1. **Use /templates/html**: For HTML content with field elements
2. **HTML element syntax**: `<text-field name="buyer_full_name" role="buyer">`
3. **Field conversion**: Use `convertFieldTagsToHtmlElements()` to convert curly braces
4. **Explicit roles**: Always include `roles: ['buyer', 'cobuyer', 'firefly_signer']` in template
5. **Proper order**: Set `order: 0` for parallel signing, `order: 1` for sequential
6. **Exact field mapping**: Template and session field names must match perfectly
7. **Consistent roles**: Use lowercase role names consistently
8. **X-Auth-Token**: Proper DocuSeal authentication header
9. **Proper .env loading**: Use full path in dev server

## Testing & Debugging Process

### 1. Template Creation Test
```bash
# PowerShell command to test template creation
Invoke-RestMethod -Uri "http://localhost:3001/api/admin/docuseal/init-templates/agreement" -Method POST
```

### 2. Environment Variable Debug
```javascript
// Add to dev server for debugging
console.log('üîë DOCUSEAL_API_KEY loaded:', process.env.DOCUSEAL_API_KEY ? 'YES (length: ' + process.env.DOCUSEAL_API_KEY.length + ')' : 'NO')
console.log('üìÅ .env path:', path.join(__dirname, '..', '.env'))
```

### 3. Session Creation Test
```javascript
// Test session creation with real order data
const session = await createPackEnvelope(orderId, 'agreement', order)
console.log('Signing URL:', session.signingUrl)
```

## File Structure Requirements

```
lib/
‚îú‚îÄ‚îÄ docuseal/
‚îÇ   ‚îú‚îÄ‚îÄ client.js                 # Unified API client with HTML endpoint
‚îÇ   ‚îî‚îÄ‚îÄ builders/
‚îÇ       ‚îú‚îÄ‚îÄ agreement.js          # Agreement template builder
‚îÇ       ‚îú‚îÄ‚îÄ delivery.js           # Delivery template builder  
‚îÇ       ‚îî‚îÄ‚îÄ final.js              # Final acknowledgment builder
‚îú‚îÄ‚îÄ contracts/
‚îÇ   ‚îî‚îÄ‚îÄ html/
‚îÇ       ‚îú‚îÄ‚îÄ agreement.js          # HTML with DocuSeal field tags
‚îÇ       ‚îú‚îÄ‚îÄ delivery.js           # Delivery agreement HTML
‚îÇ       ‚îú‚îÄ‚îÄ final.js              # Final acknowledgment HTML
‚îÇ       ‚îî‚îÄ‚îÄ field-converter.js    # üö® CRITICAL: Converts {{}} to HTML elements
backend/
‚îî‚îÄ‚îÄ dev-server.js                 # Dev server with template endpoints
```

## Success Criteria

### Template Creation Success
- ‚úÖ Template ID returned (e.g., 1710241, 1710288)
- ‚úÖ Template visible in DocuSeal dashboard
- ‚úÖ Template shows formatted document (not raw HTML)
- ‚úÖ Fields are properly mapped and interactive
- ‚úÖ **CRITICAL**: Template has `fields` array with parsed field elements
- ‚úÖ **CRITICAL**: Template has `submitters` array with correct roles

### Signing Experience Success  
- ‚úÖ "Open Full View" shows formatted PDF
- ‚úÖ "Start Signing" shows identical formatted document
- ‚úÖ All buyer/model/pricing data auto-populated
- ‚úÖ Signature and initial fields are interactive
- ‚úÖ Co-buyer fields work when present

## Emergency Troubleshooting

### Common Errors & Solutions
1. **"DOCUSEAL_API_KEY environment variable is required"**
   - Check .env file exists and has correct API key
   - Verify dev server loads .env from project root
   - Restart dev server after .env changes

2. **"DOCUSEAL_BASE is not defined"**
   - Check variable naming consistency in client.js
   - Use `BASE` internally, load from `DOCUSEAL_BASE_URL`

3. **"Failed to execute 'json' on 'Response'"**
   - API server not running or wrong port
   - Check Vite proxy configuration
   - Verify API endpoint exists in dev server

4. **Raw HTML shown in DocuSeal instead of formatted document**
   - Using wrong endpoint (/templates/docx instead of /templates/html)
   - Incorrect field tag syntax
   - Need to recreate template with HTML endpoint

5. **"422 Template does not contain fields" error**
   - **ROOT CAUSE**: Using curly brace syntax `{{field}}` with HTML API
   - **SOLUTION**: Use HTML element syntax `<text-field name="field">`
   - **FIX**: Implement `convertFieldTagsToHtmlElements()` function
   - **VERIFY**: Check template has populated `fields` array

6. **"500 Internal Server Error" during session creation**
   - Missing `roles` array in template creation
   - Missing `order` field in submitters array
   - Incorrect signing URL extraction logic
   - **FIX**: Add `roles: ['buyer', 'cobuyer', 'firefly_signer']` to template
   - **FIX**: Add `order: 0` for parallel, `order: 1` for sequential signing

## üö® FINAL WORKING SOLUTION SUMMARY

**The complete solution that resolves all DocuSeal integration issues:**

1. **Field Conversion**: Use `lib/contracts/html/field-converter.js` to convert `{{field}}` ‚Üí `<text-field>`
2. **HTML API**: Use `/templates/html` endpoint with HTML element syntax
3. **Template Roles**: Always include `roles: ['buyer', 'cobuyer', 'firefly_signer']`
4. **Submitter Order**: Use `order: 0` for parallel, `order: 1` for sequential signing
5. **Exact Field Names**: Match template field names exactly in session data
6. **Working Templates**: Use IDs `1710241` (agreement) and `1710288` (delivery)

This rule captures the complete DocuSeal integration process that took hours to debug and perfect. Follow these patterns exactly for consistent success.